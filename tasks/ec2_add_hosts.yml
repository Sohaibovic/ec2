- debug: 
    var: ec2_instance_tags.Role
    verbosity: 2

- name: Gather facts for instances with Name {{ ec2_scope }} and Role {{ ec2_instance_tags.Role }}
  ec2_instance_facts:
    region: "{{ ec2_region }}"
    filters:
      "tag:Name": "{{ ec2_scope }}"
      "tag:Role":  "{{ ec2_instance_tags.Role }}"
      "instance-state-name": running
  register: ec2
  
- debug: 
    var: ec2.instances 
    verbosity: 2

- debug: 
    msg: "{{ ec2.instances | map(attribute='private_ip_address') | list }}"
    verbosity: 2

- name: Build a list of ips and hostnames
  vars:
    ips_to_add: "{{ ec2.instances | map(attribute='private_ip_address') | list }}"
  set_fact:
    ips_to_add: "{{ ips_to_add }}"

- name: Display private IPs that were allocated
  debug: 
    var: ips_to_add
    verbosity: 2

- name: Create list of tags
  set_fact:
    tags: []

- name: Build list of groups based on tags
  set_fact:
    tags: "{{ tags }} + [ 'tag_{{item.key}}_{{item.value}}' ]" 
  loop: "{{ ec2_instance_tags |dict2items  }}"

- debug: 
    msg: "{{ ec2_instance_tags |dict2items  }}"
    verbosity: 2

- debug: 
    var: tags
    verbosity: 2

- name: Add hosts to in-memory inventory
  add_host:
    name: "{{ item }}"
    groups: "{{ tags }}"
  with_items: "{{ ips_to_add }}"

- name: Wait for SSH to come up
  wait_for_connection:
    timeout: 600
    sleep: 15
  delegate_to: "{{ item }}"
  with_items: "{{ ips_to_add }}"